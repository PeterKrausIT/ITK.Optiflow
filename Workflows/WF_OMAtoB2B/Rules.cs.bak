#define DESIGNTIME

#if DESIGNTIME
//------------- DESIGN TIME CODE ----------------
// the next lines are not part of the rule file. They are just there to make the .CS valid in design time...
using System;
using System.Runtime.InteropServices;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using MB.Module;
namespace TEMPO
{
    class CTempo
    {
        private void tempo()
        {
            MB.Module.OrderDictionary Dicti = null;
            // ------------- End of design time code -------------------------------------------------------------------
#endif


            // Rules for PairOrders....

            if (Dicti.ContainsKey("PairOrders"))
            {
                foreach (OrderDictionary od in (Dicti["PairOrders"] as OrderDictionary[]))
                {

                    try
                    {
                        // JobID for logging
                        if (od.ContainsKey("JOB"))
                            log4net.ThreadContext.Properties["Job"] = od["JOB"].ToString();
                        else
                            log4net.ThreadContext.Properties["Job"] = "";
                        //parent.LogVerbose("Rule engine...", -1);

                        // 

                        // Right lens
                        try
                        {
                            if (od.ContainsKey("_LENSID.R"))
                            {
                                string LENSID = od["_LENSID.R"].ToString().Trim();

                                int LensType = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<string>("LensType");

                                int LensMaterial = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            //&& myRow.Field<string>("_color_name_cd").StartsWith(color_name_cd, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<int>("LensMaterial");

                                int LensIndex = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            //&& myRow.Field<string>("_color_name_cd").StartsWith(color_name_cd, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<int>("LensIndex");

                                od.SetValue("LIND", (decimal)LensIndex / 10000m); // Index in Mokka ist z.B. 15700
                                /* LensType in SF6:
                                    0=Einstärken
                                    1=Bifo
                                    2=Trifo
                                    3=Gleitsicht 
                                    4=Arbeitsplatzglas / Officeglas
                                 */
                                switch (LensType)
                                {
                                    case 0: od.SetValue("LTYPE.R", "SV"); break;
                                    case 1: od.SetValue("LTYPE.R", "BI"); break;
                                    case 2: od.SetValue("LTYPE.R", "TR"); break;
                                    case 3: od.SetValue("LTYPE.R", "PL"); break;
                                    case 4: od.SetValue("LTYPE.R", "PL"); break;
                                }
                                /* LensMaterial in SF6:
                                    1=Silikat 
                                    2=Kunststoff 
                                    3=Polycarbonat
                                    4=Trivex
                                 */
                                switch (LensMaterial)
                                {
                                    case 1: od.SetValue("LMATTYPE.R", 3); break;
                                    case 2: od.SetValue("LMATTYPE.R", 1); break;
                                    case 3: od.SetValue("LMATTYPE.R", 2); break;
                                    case 4: od.SetValue("LMATTYPE.R", 6); break;
                                }
                            }
                        }
                        catch (System.Exception exx)
                        {
                            System.Console.WriteLine(exx.ToString());
                            od.SetValue("_ERROR", exx.ToString());
                            od.SetValue("_SKIPJOB", true);
                            MBActivity.LogError("Can't find mapping for lens code " + od["_LENSID.R"].ToString() /*+ "\r\n" + exx.ToString()*/, -2, "B2BtoOMA");
                        }
                        // Calculate FBOCIN and FBOCUP
                        if (od.ContainsKey("IPD.R") &&
                            od.ContainsKey("OCHT.R") &&
                            od.ContainsKey("HBOX.R") &&
                            od.ContainsKey("VBOX.R") &&
                            od.ContainsKey("DBL"))
                        {
                            decimal IPD = (decimal)od["IPD.R"];
                            decimal OCHT = (decimal)od["OCHT.R"];
                            decimal HBOX = (decimal)od["HBOX.R"];
                            decimal VBOX = (decimal)od["VBOX.R"];
                            decimal DBL = (decimal)od["DBL"];
                            decimal FBOCIN = (HBOX + DBL) / 2m - IPD;
                            decimal FBOCUP = OCHT - VBOX / 2m;
                            od.SetValue("FBOCIN.R", FBOCIN);
                            od.SetValue("FBOCUP.R", FBOCUP);
                        }

                        // Left lens
                        try
                        {
                            if (od.ContainsKey("_LENSID.L"))
                            {
                                string LENSID = od["_LENSID.L"].ToString().Trim();

                                int LensType = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<string>("LensType");

                                int LensMaterial = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            //&& myRow.Field<string>("_color_name_cd").StartsWith(color_name_cd, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<int>("LensMaterial");

                                int LensIndex = Mapping["LCLensType"].Where(
                                            myRow => myRow.Field<string>("LensCode").StartsWith(LENSID, StringComparison.CurrentCultureIgnoreCase)
                                            //&& myRow.Field<string>("_color_name_cd").StartsWith(color_name_cd, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<int>("LensIndex");

                                od.SetValue("LIND", (decimal)LensIndex / 10000m); // Index in Mokka ist z.B. 15700
                                /* LensType in SF6:
                                    0=Einstärken
                                    1=Bifo
                                    2=Trifo
                                    3=Gleitsicht 
                                    4=Arbeitsplatzglas / Officeglas
                                 */
                                switch (LensType)
                                {
                                    case 0: od.SetValue("LTYPE.L", "SV"); break;
                                    case 1: od.SetValue("LTYPE.L", "BI"); break;
                                    case 2: od.SetValue("LTYPE.L", "TR"); break;
                                    case 3: od.SetValue("LTYPE.L", "PL"); break;
                                    case 4: od.SetValue("LTYPE.L", "PL"); break;
                                }
                                /* LensMaterial in SF6:
                                    1=Silikat 
                                    2=Kunststoff 
                                    3=Polycarbonat
                                    4=Trivex
                                 */
                                switch (LensMaterial)
                                {
                                    case 1: od.SetValue("LMATTYPE.L", 3); break;
                                    case 2: od.SetValue("LMATTYPE.L", 1); break;
                                    case 3: od.SetValue("LMATTYPE.L", 2); break;
                                    case 4: od.SetValue("LMATTYPE.L", 6); break;
                                }
                            }
                        }
                        catch (System.Exception exx)
                        {
                            System.Console.WriteLine(exx.ToString());
                            od.SetValue("_ERROR", exx.ToString());
                            od.SetValue("_SKIPJOB", true);
                            MBActivity.LogError("Can't find mapping for lens code " + od["_LENSID.L"].ToString() /*+ "\r\n" + exx.ToString()*/, -2, "B2BtoOMA");
                        }
                        // Calculate FBOCIN and FBOCUP
                        if (od.ContainsKey("IPD.L") &&
                            od.ContainsKey("OCHT.L") &&
                            od.ContainsKey("HBOX.L") &&
                            od.ContainsKey("VBOX.L") &&
                            od.ContainsKey("DBL"))
                        {
                            decimal IPD = (decimal)od["IPD.L"];
                            decimal OCHT = (decimal)od["OCHT.L"];
                            decimal HBOX = (decimal)od["HBOX.L"];
                            decimal VBOX = (decimal)od["VBOX.L"];
                            decimal DBL = (decimal)od["DBL"];
                            decimal FBOCIN = (HBOX + DBL) / 2m - IPD;
                            decimal FBOCUP = OCHT - VBOX / 2m;
                            od.SetValue("FBOCIN.L", FBOCIN);
                            od.SetValue("FBOCUP.L", FBOCUP);
                        }


                        // Values for both lenses

                        // _SBEV muss noch aus B2B <edging><champfer> kommen !
                        if (od.ContainsKey("_SBEV"))
                        {
                            if (od["_SBEV"].StartsWith("THIN")) od.SetValue("SBEV", 0.1m);
                            if (od["_SBEV"].StartsWith("MED")) od.SetValue("SBEV", 0.2m);
                            if (od["_SBEV"].StartsWith("LARGE")) od.SetValue("SBEV", 0.4m);
                        }

                        // _ADJUSTMENT muss noch aus B2B <tracerData><adjustion> kommen
                        // dies kann auf Wunsch auch nach CSIZ umgestellt werden:
                        if (od.ContainsKey("_ADJUSTION"))
                            od.SetValue("BSIZ", od["_ADJUSTION"]);

                        string COATID = "";
                        if (od.ContainsKey("ACOAT.R")) COATID = od["ACOAT.R"].ToString().Trim();
                        else if (od.ContainsKey("ACOAT.L")) COATID = od["ACOAT.L"].ToString().Trim();

                        if (COATID.Length > 0)
                        {
                            try { 
                            // in die SBMokka.LCOptions muss man noch ein Feld "_LCOAT <int>" hinzufügen
                            int _LCOAT = Mapping["LCOptions"].Where(
                                            myRow => myRow.Field<string>("Code").StartsWith(COATID, StringComparison.CurrentCultureIgnoreCase)
                                            ).FirstOrDefault().Field<int>("_LCOAT");

                            }
                            catch (System.Exception exx)
                            {
                                System.Console.WriteLine(exx.ToString());
                                od.SetValue("_ERROR", exx.ToString());
                                od.SetValue("_SKIPJOB", true);
                                MBActivity.LogError("Can't find mapping for option code " + COATID, -2, "B2BtoOMA");
                            }
                        }
                    }
                    catch (System.Exception exx)
                    {
                        System.Console.WriteLine(exx.ToString());
                        od.SetValue("_ERROR", exx.ToString());
                        od.SetValue("_SKIPJOB", true);
                        MBActivity.LogError(exx.ToString(), 1801, "B2BtoD365");
                    }

                    log4net.ThreadContext.Properties["Job"] = "";
                    Dicti.SetValue("RuleEngine", "executed");
                }
            }
#if DESIGNTIME
            //------------- DESIGN TIME CODE ----------------
        }
    }
}
//------------- END OF DESIGN TIME CODE ---------
#endif