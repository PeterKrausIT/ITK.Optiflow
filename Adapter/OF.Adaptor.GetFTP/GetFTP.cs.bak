// ***********************************************************************
// Assembly         : MB.Adapter.GetFTP
// Author           : Peter Kraus
// Created          : 01-10-2020
//
// Last Modified By : Peter Kraus
// Last Modified On : 03-23-2020
// ***********************************************************************
// <copyright file="GetFTP.cs" company="Peter Kraus IT-Dienste GmbH">
//     Copyright © Peter Kraus IT-Dienste GmbH 2020
// </copyright>
// <summary>GetFTP.cs
// <br> Gets files from FTP server and renames them when done </summary>
// ***********************************************************************
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MB.Module;
using System.Activities;
using System.ComponentModel;
using System.Activities.Presentation.Metadata;
using System.IO;
using System.Net;
using System.Windows.Shapes;

/// <summary>
/// The GetFTP namespace.
/// </summary>
namespace MB.Adapter.GetFTP
{
    /// <summary>
    /// Get next messages from a FTP server in a byte buffer and rename files on the server.
    /// </summary>
    public sealed class GetFTP : MBActivity, IOFModule
    {
        /// <summary>
        /// The m identifier
        /// </summary>
        private readonly Guid mID = new Guid("128DCF91-7261-42A8-BCC3-61296CF0AEC0");
        /// <summary>
        /// The m name
        /// </summary>
        private readonly string mName = "GetFTP Adapter";
        /// <summary>
        /// The m description
        /// </summary>
        private readonly string mDescription = "Reading messages from a FTP server.";


        /// <summary>
        /// Parameterless constructor
        /// </summary>
        public GetFTP()
        {
            PerfCount.Name = Name;
        }

        /// <summary>
        /// The ID of this Activity is 128DCF91-7261-42A8-BCC3-61296CF0AEC0
        /// </summary>
        /// <value>The identifier.</value>
        public Guid ID
        {
            get { return mID; }
        }

        /// <summary>
        /// Name of activity
        /// </summary>
        /// <value>The name.</value>
        public string Name
        {
            get { return mName; }
        }

        /// <summary>
        /// Gets description of activity
        /// </summary>
        /// <value>The description.</value>
        public string Description
        {
            get { return mDescription; }
        }


        /// <summary>
        /// Gets or sets the ftp server.
        /// </summary>
        /// <value>The ftp server.</value>
        private string fTPServer { get; set; }
        /// <summary>
        /// Gets or sets the username.
        /// </summary>
        /// <value>The username.</value>
        private string username { get; set; }
        /// <summary>
        /// Gets or sets the password.
        /// </summary>
        /// <value>The password.</value>
        private string password { get; set; }
        /// <summary>
        /// Gets or sets the subdirectory.
        /// </summary>
        /// <value>The subdirectory.</value>
        private string subdir { get; set; }
        /// <summary>
        /// Gets or sets the wfid.
        /// </summary>
        /// <value>The wfid.</value>
        private string wFID { get; set; }
        /// <summary>
        /// The MSG extension
        /// </summary>
        private string msgExtension = Guid.NewGuid().ToString();
        private string renameWhenDone = "";
        /// <summary>
        /// The filename
        /// </summary>
        private string filename = "";
        /// <summary>
        /// The message
        /// </summary>
        private string message = "";
        /// <summary>
        /// The result
        /// </summary>
        private int result = -1; // -1 = undefined

        /// <summary>
        /// Next got message
        /// </summary>
        /// <value>The message.</value>
        public OutArgument<string> Message { get; set; }
        /// <summary>
        /// Message ID (Filename + Date)
        /// </summary>
        /// <value>The message id.</value>
        public OutArgument<string> MID { get; set; }
        /// <summary>
        /// Filename got
        /// </summary>
        /// <value>The filename.</value>
        public OutArgument<string> Filename { get; set; }
        /// <summary>
        /// Address of the FTP server to read from
        /// </summary>
        /// <value>The FTP server.</value>
        public InArgument<string> FTPServer { get; set; }
        /// <summary>
        /// Username for FTP login
        /// </summary>
        /// <value>The username.</value>
        public InArgument<string> Username { get; set; }
        /// <summary>
        /// Password for FTP login
        /// </summary>
        /// <value>The password.</value>
        public InArgument<string> Password { get; set; }
        /// <summary>
        /// Subdirectory to get messages from.
        /// </summary>
        /// <value>The subdirectory.</value>
        public InArgument<string> Subdir { get; set; }
        /// <summary>
        /// File extensions for the message files
        /// </summary>
        /// <value>The MSG extension.</value>
        public InArgument<string> MsgExtension { get; set; }
        /// <summary>
        /// Flag indicating if the files shall be deleted from the FTP server after successfull download
        /// </summary>
        /// <value>The rename when done.</value>
        public InArgument<string> RenameWhenDone { get; set; }
        /// <summary>
        /// WorkflowID for the used Workflow (to be saved with the message).
        /// </summary>
        /// <value>The wfid.</value>
        public InArgument<String> WFID { get; set; }


        /// <summary>
        /// Execution of activity
        /// </summary>
        /// <param name="context">The context.</param>
        [DefaultValue(null)]
        protected override void Execute(NativeActivityContext context)
        {
            PerfCount.StartJob();
            try
            {
                fTPServer = FTPServer.Get(context);
                username = Username.Get(context);
                password = Password.Get(context);
                subdir = Subdir.Get(context);
                if (subdir == null) subdir = "";
                renameWhenDone = RenameWhenDone.Get(context);
                wFID = WFID.Get(context);

                LogInfo("GetFTP started", 101, wFID);
                msgExtension = MsgExtension.Get(context).ToUpper();

                // Looking for a new file on FTP server ...
                result = GetFileFromFTP();
                Message.Set(context, message);
                Result.Set(context, result);
                Filename.Set(context, filename);

                LogInfo("GetFTP finished with result=" + result.ToString(), 102, wFID);
            }
            catch (System.Exception ex)
            {
                LogError(ex, 2, wFID);
            }
            PerfCount.EndJob((result > 0) ? 1 : 0); // result : 0);
        }

        /// <summary>
        /// Registers the metadata.
        /// </summary>
        public static void RegisterMetadata()
       {
            AttributeTableBuilder builder = new AttributeTableBuilder();
            builder.AddCustomAttributes(typeof(MB.Adapter.GetFTP.GetFTP), new DesignerAttribute(typeof(MB.Adapter.GetFTP.GetFTPDesigner)));
            MetadataStore.AddAttributeTable(builder.CreateTable());
       }

        /// <summary>
        /// Get next files from the FTP server.
        /// </summary>
        /// <returns>Number of files that were found</returns>
        private int GetFileFromFTP()
        {
            // TODO: Sort files by date and process the oldest file first
            int filecount = 0; // no files found so far
            filename = "";

            // Get the object used to communicate with the server.
            string path = fTPServer;

            if (subdir.Length > 0)
            {
                //path = fTPServer + "/%2F/" + subdir;
                path = fTPServer + "/" + subdir;
                //string[] subfolders = subdir.Split(new char[] { '\\', '/' });
                //foreach (string folder in subfolders)
                //{
                //    FtpWebRequest request1 = (FtpWebRequest)WebRequest.Create(path, folder);//fTPServer);
                //    request1.Method = WebRequestMethods.Ftp.ChangeDirectory;//.ListDirectoryDetails;
                //    request1.Credentials = new NetworkCredential(username, password);
                //}
            }

            FtpWebRequest request = (FtpWebRequest)WebRequest.Create(path);//fTPServer);
            request.Method = WebRequestMethods.Ftp.ListDirectory;//.ListDirectoryDetails;
            request.Credentials = new NetworkCredential(username, password);
            request.Proxy = null;

            LogInfo("Connect to server: " + fTPServer, 200, wFID);

            FtpWebResponse response = (FtpWebResponse)request.GetResponse();

            Stream responseStream = response.GetResponseStream();
            StreamReader reader = new StreamReader(responseStream);

            try
            {
                while (!reader.EndOfStream)
                {
                    string line = reader.ReadLine();
                    string regMsgPattern = "";

                    if (msgExtension.StartsWith("@"))
                        regMsgPattern = msgExtension.Substring(1);

                    if (!string.IsNullOrEmpty(line))
                    {
                        if ((regMsgPattern.Length > 0) && System.Text.RegularExpressions.Regex.IsMatch(line, regMsgPattern))
                        {
                            filecount++;
                            if (String.IsNullOrEmpty(filename))
                            {
                                filename = line;
                                if (subdir.Length > 0)
                                    line = subdir + "/" + line;
                                //filename = line;
                                LogInfo("New Msg file: " + line, 201, wFID);
                            }
                        }
                        else if (line.ToUpper().EndsWith("." + msgExtension, StringComparison.InvariantCultureIgnoreCase))
                        {
                            filecount++;
                            filename = line;
                            int pos = filename.LastIndexOf("/");
                            if (pos >= 0)
                                filename = filename.Substring(pos + 1);
                            if (String.IsNullOrEmpty(filename))
                            {
                                filename = line;
                                if (subdir.Length > 0)
                                    line = subdir + "/" + line;
                                //filename = line;
                                LogInfo("New Msg file: " + line, 201, wFID);
                            }
                        }
                    }
                }
            } catch(Exception exx) {
                LogInfo("Exception: " + exx.ToString(), 201, wFID);
            }

            if (response.StatusDescription.Contains("225"))
                LogVerbose(String.Format("Directory List Complete, status {0}", response.StatusDescription), 204, wFID);
            else
                LogInfo(String.Format("Directory List Complete, status {0}", response.StatusDescription), 204, wFID);

            reader.Close();
            response.Close();

            if (!String.IsNullOrEmpty(filename))
            {
                log4net.ThreadContext.Properties["Message"] = filename;
                LogInfo("Load Msg file: " + path + "/" + filename + " ...", 205, wFID);
                request = (FtpWebRequest)WebRequest.Create(path + "/" + filename);
                request.Credentials = new NetworkCredential(username, password);
                request.Method = WebRequestMethods.Ftp.DownloadFile;
                request.Proxy = null;
                response = (FtpWebResponse)request.GetResponse();
                responseStream = response.GetResponseStream();
                reader = new StreamReader(responseStream);
                message = reader.ReadToEnd();
                reader.Close();
                response.Close();
                LogVerbose("Done.", 206, wFID);

                if (renameWhenDone.Length > 0)
                {
                    try
                    {
                        LogInfo("Rename Msg file: " + filename + " to " + filename + "." + renameWhenDone, 220, wFID);
                        request = (FtpWebRequest)WebRequest.Create(path + "/" +  filename);
                        request.Credentials = new NetworkCredential(username, password);
                        request.Method = WebRequestMethods.Ftp.Rename;
                        request.RenameTo = filename + "." + renameWhenDone;
                        request.Proxy = null;
                        request.UseBinary = true;
                        response = (FtpWebResponse)request.GetResponse();
                        LogInfo(String.Format("Rename complete, status: {0}", response.StatusDescription), 221, wFID);
                        response.Close();
                    }
                    catch (WebException e)
                    {
                        String status = ((FtpWebResponse)e.Response).StatusDescription;
                        throw new System.Exception(status);
                    }
                }

                
            }

            return filecount;
        }
    }
}
