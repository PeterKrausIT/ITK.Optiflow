// ***********************************************************************
// Assembly         : MB.Adapter.SendFTP
// Author           : Peter Kraus
// Created          : 02-16-2019
//
// Last Modified By : Nils Kraus
// Last Modified On : 05-04-2020
// ***********************************************************************
// <copyright file="SendFTP.cs" company="Peter Kraus IT-Dienste GmbH">
//     Copyright © Peter Kraus IT-Dienste GmbH 2020
// </copyright>
// <summary>SendFTP.cs
// <br> Sends files to server via FTP </summary>
// ***********************************************************************
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MB.Module;
using System.Activities;
using System.ComponentModel;
using System.Activities.Presentation.Metadata;
using System.IO;
using System.Net;


/// <summary>
/// The SendFTP namespace.
/// </summary>
namespace MB.Adapter.SendFTP
{
    /// <summary>
    /// "Adapter" activity to send messages to a FTP server
    /// </summary>
    public sealed class SendFTP : MBActivity, IOFModule
    {
        /// <summary>
        /// The m identifier
        /// </summary>
        private readonly Guid mID = new Guid("128DCF91-7261-4248-BCC3-61596CF0AEC0");
        /// <summary>
        /// The m name
        /// </summary>
        private readonly string mName = "SendFTP Adapter";
        /// <summary>
        /// The m description
        /// </summary>
        private readonly string mDescription = "Sending a message to a FTP server.";

        /// <summary>
        /// Parameterless constructor
        /// </summary>
        public SendFTP()
        {
            PerfCount.Name = Name;
        }

        /// <summary>
        /// ID of this activity
        /// </summary>
        /// <value>The identifier.</value>
        public Guid ID
        {
            get { return mID; }
        }

        /// <summary>
        /// Name of this Activity
        /// </summary>
        /// <value>The name.</value>
        public string Name
        {
            get { return mName; }
        }

        /// <summary>
        /// Description of this activity
        /// </summary>
        /// <value>The description.</value>
        public string Description
        {
            get { return mDescription; }
        }

        /// <summary>
        /// Gets or sets the ftp server.
        /// </summary>
        /// <value>The ftp server.</value>
        private string fTPServer { get; set; }
        /// <summary>
        /// Gets or sets the username.
        /// </summary>
        /// <value>The username.</value>
        private string username { get; set; }
        /// <summary>
        /// Gets or sets the password.
        /// </summary>
        /// <value>The password.</value>
        private string password { get; set; }
        /// <summary>
        /// Gets or sets the subdirectory.
        /// </summary>
        /// <value>The subdirectory.</value>
        private string subdir { get; set; }

        /// <summary>
        /// Input parameter: FTP server address
        /// </summary>
        /// <value>The FTP server address.</value>
        public InArgument<string> FTPServer { get; set; }
        /// <summary>
        /// Input parameter: FTP user name
        /// </summary>
        /// <value>The username.</value>
        public InArgument<string> Username { get; set; }
        /// <summary>
        /// Input parameter: FTP password
        /// </summary>
        /// <value>The password.</value>
        public InArgument<string> Password { get; set; }
        /// <summary>
        /// Input parameter: Sub directory to send to
        /// </summary>
        /// <value>The subdirectory.</value>
        public InArgument<string> Subdir { get; set; }
        /// <summary>
        /// Input parameter: Message to be sent
        /// </summary>
        /// <value>The message.</value>
        public InArgument<string> Message { get; set; }
        /// <summary>
        /// Input parameter: Filename to generate
        /// </summary>
        /// <value>The filename.</value>
        public InArgument<string> Filename { get; set; }
        /// <summary>
        /// The filename
        /// </summary>
        private string filename = "";
        /// <summary>
        /// The message
        /// </summary>
        private string message = "";

        // alternatively you can send from the order table:
        /// <summary>
        /// Workflow ID which this activity belongs to
        /// </summary>
        /// <value>The wfid.</value>
        public InArgument<string> WFID { get; set; }
        /// <summary>
        /// State of the messages to be sent
        /// </summary>
        private string wFID;

        /// <summary>
        /// Execution of activity
        /// </summary>
        /// <param name="context">The context.</param>
        protected override void Execute(NativeActivityContext context)
        {
            int Result_ = 0;

            mPerfCount.StartJob();

            fTPServer = FTPServer.Get(context);
            username = Username.Get(context);
            password = Password.Get(context);
            subdir = Subdir.Get(context);
            if (subdir == null)
                subdir = "";

            LogInfo("SendFTP started in single file mode", 102, wFID);
            // send a message as a file
            message = Message.Get(context);
            filename = Filename.Get(context);
            try
            {
                LogInfo("Send file: " + filename + " to " + fTPServer + "/" + subdir, 401, wFID);
                SendFile();
            }
            catch (System.Exception ex)
            {
                LogError(ex, 801, wFID);
            }

            LogInfo("SendFTP finished.", 103, wFID);
            mPerfCount.EndJob(1);
            Result.Set(context, Result_);
        }

        /// <summary>
        /// Send one file by FTP
        /// </summary>
        private void SendFile()
        {
            //local copy for testing:
            //using (StreamWriter outfile = new StreamWriter(filename))
            //    outfile.Write(message);

            // Get the object used to communicate with the server.
            string path = fTPServer + "/" + filename;
            if (subdir.Length > 0)
            {
                path = fTPServer + "/" + subdir + "/" + filename;
            }

            FtpWebRequest request = (FtpWebRequest)WebRequest.Create(path);
            request.Method = WebRequestMethods.Ftp.UploadFile;
            request.Credentials = new NetworkCredential(username, password);

            byte [] fileContents = Encoding.UTF8.GetBytes(message);
            request.ContentLength = fileContents.Length;

            Stream requestStream = request.GetRequestStream();
            requestStream.Write(fileContents, 0, fileContents.Length);
            requestStream.Close();

            FtpWebResponse response = (FtpWebResponse)request.GetResponse();
    
            LogInfo(string.Format("Upload File Complete, status {0}", response.StatusDescription.Replace("\r","").Replace("\n", "")), 321, wFID);
    
            response.Close();

        }

        /// <summary>
        /// register MS WFF meta data
        /// </summary>
        public static void RegisterMetadata()
       {
            AttributeTableBuilder builder = new AttributeTableBuilder();
            builder.AddCustomAttributes(typeof(MB.Adapter.SendFTP.SendFTP), new DesignerAttribute(typeof(MB.Adapter.SendFTP.SendFTPDesigner)));
            MetadataStore.AddAttributeTable(builder.CreateTable());
       }
    }
}
